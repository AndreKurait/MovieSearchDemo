apiVersion: batch/v1
kind: Job
metadata:
  name: load-movies
  namespace: movie-demo
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: loader
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          ES_URL="http://elasticsearch.movie-demo.svc.cluster.local:9200"
          
          echo "Waiting for Elasticsearch..."
          until curl -s "$ES_URL/_cluster/health" | grep -q '"status":"green"\|"status":"yellow"'; do
            sleep 5
          done
          
          echo "Creating movies index..."
          curl -s -X PUT "$ES_URL/movies" -H 'Content-Type: application/json' -d '{
            "mappings": {
              "properties": {
                "title": {"type": "text", "analyzer": "english"},
                "tagline": {"type": "text"},
                "overview": {"type": "text", "analyzer": "english"},
                "genres": {"type": "keyword"},
                "release_date": {"type": "date"},
                "vote_average": {"type": "float"},
                "vote_count": {"type": "integer"},
                "popularity": {"type": "float"}
              }
            }
          }' || true
          
          echo "Loading movies..."
          curl -s -X POST "$ES_URL/movies/_bulk" -H 'Content-Type: application/json' -d '
          {"index":{"_id":"1"}}
          {"title":"The Shawshank Redemption","tagline":"Fear can hold you prisoner. Hope can set you free.","overview":"Framed in the 1940s for the double murder of his wife and her lover, upstanding banker Andy Dufresne begins a new life at the Shawshank prison, where he puts his accounting skills to work for an arbitrary warden.","genres":["Drama","Crime"],"release_date":"1994-09-23","vote_average":8.7,"vote_count":24000,"popularity":80.5}
          {"index":{"_id":"2"}}
          {"title":"The Godfather","tagline":"An offer you cannot refuse.","overview":"Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch Vito Corleone barely survives an attempt on his life, his youngest son Michael steps in.","genres":["Drama","Crime"],"release_date":"1972-03-14","vote_average":8.7,"vote_count":18000,"popularity":75.2}
          {"index":{"_id":"3"}}
          {"title":"The Dark Knight","tagline":"Why so serious?","overview":"Batman raises the stakes in his war on crime. With the help of Lt. Jim Gordon and District Attorney Harvey Dent, Batman sets out to dismantle the remaining criminal organizations that plague the streets.","genres":["Action","Crime","Drama"],"release_date":"2008-07-16","vote_average":8.5,"vote_count":29000,"popularity":90.1}
          {"index":{"_id":"4"}}
          {"title":"Pulp Fiction","tagline":"Just because you are a character does not mean you have character.","overview":"A burger-loving hit man, his philosophical partner, a drug-addled gangster moll and a washed-up boxer converge in this sprawling, comedic crime caper.","genres":["Crime","Thriller"],"release_date":"1994-09-10","vote_average":8.5,"vote_count":25000,"popularity":70.3}
          {"index":{"_id":"5"}}
          {"title":"Inception","tagline":"Your mind is the scene of the crime.","overview":"Cobb, a skilled thief who commits corporate espionage by infiltrating the subconscious of his targets is offered a chance to regain his old life as payment for a task considered to be impossible.","genres":["Action","Science Fiction","Adventure"],"release_date":"2010-07-15","vote_average":8.4,"vote_count":33000,"popularity":85.7}
          {"index":{"_id":"6"}}
          {"title":"The Matrix","tagline":"Welcome to the Real World.","overview":"Set in the 22nd century, The Matrix tells the story of a computer hacker who joins a group of underground insurgents fighting the vast and powerful computers who now rule the earth.","genres":["Action","Science Fiction"],"release_date":"1999-03-30","vote_average":8.2,"vote_count":22000,"popularity":78.9}
          {"index":{"_id":"7"}}
          {"title":"Forrest Gump","tagline":"Life is like a box of chocolates...you never know what you are gonna get.","overview":"A man with a low IQ has accomplished great things in his life and been present during significant historic eventsâ€”in each case, far exceeding what anyone imagined he could do.","genres":["Comedy","Drama","Romance"],"release_date":"1994-06-23","vote_average":8.5,"vote_count":24000,"popularity":72.4}
          {"index":{"_id":"8"}}
          {"title":"Interstellar","tagline":"Mankind was born on Earth. It was never meant to die here.","overview":"The adventures of a group of explorers who make use of a newly discovered wormhole to surpass the limitations on human space travel and conquer the vast distances involved in an interstellar voyage.","genres":["Adventure","Drama","Science Fiction"],"release_date":"2014-11-05","vote_average":8.4,"vote_count":31000,"popularity":88.2}
          {"index":{"_id":"9"}}
          {"title":"Fight Club","tagline":"Mischief. Mayhem. Soap.","overview":"A ticking-Loss time bomb insomniac and a slippery soap salesman channel primal male aggression into a shocking new form of therapy. Their concept catches on, with underground fight clubs.","genres":["Drama"],"release_date":"1999-10-15","vote_average":8.4,"vote_count":26000,"popularity":65.8}
          {"index":{"_id":"10"}}
          {"title":"Goodfellas","tagline":"Three Decades of Life in the Mafia.","overview":"The story of Henry Hill and his life in the mob, covering his relationship with his wife Karen Hill and his mob partners Jimmy Conway and Tommy DeVito in the Italian-American crime syndicate.","genres":["Drama","Crime"],"release_date":"1990-09-12","vote_average":8.5,"vote_count":11000,"popularity":55.3}
          {"index":{"_id":"11"}}
          {"title":"The Lord of the Rings: The Return of the King","tagline":"The eye of the enemy is moving.","overview":"Aragorn is revealed as the heir to the ancient kings as he, Gandalf and the other members of the broken fellowship struggle to save Gondor from Saurons forces.","genres":["Adventure","Fantasy","Action"],"release_date":"2003-12-01","vote_average":8.5,"vote_count":21000,"popularity":82.1}
          {"index":{"_id":"12"}}
          {"title":"Star Wars: Episode V - The Empire Strikes Back","tagline":"The Adventure Continues.","overview":"The epic saga continues as Luke Skywalker, in hopes of defeating the evil Galactic Empire, learns the ways of the Jedi from aging master Yoda.","genres":["Adventure","Action","Science Fiction"],"release_date":"1980-05-20","vote_average":8.4,"vote_count":14000,"popularity":60.5}
          {"index":{"_id":"13"}}
          {"title":"Schindlers List","tagline":"Whoever saves one life, saves the world entire.","overview":"The true story of how businessman Oskar Schindler saved over a thousand Jewish lives from the Nazis while they worked as slaves in his factory during World War II.","genres":["Drama","History","War"],"release_date":"1993-11-30","vote_average":8.6,"vote_count":14000,"popularity":50.2}
          {"index":{"_id":"14"}}
          {"title":"Spirited Away","tagline":"The tunnel led Chihiro to a mysterious town.","overview":"A young girl, Chihiro, becomes trapped in a strange new world of spirits. When her parents undergo a mysterious transformation, she must call upon the courage she never knew she had.","genres":["Animation","Family","Fantasy"],"release_date":"2001-07-20","vote_average":8.5,"vote_count":14000,"popularity":68.9}
          {"index":{"_id":"15"}}
          {"title":"Parasite","tagline":"Act like you own the place.","overview":"All unemployed, Ki-taeks family takes peculiar interest in the wealthy and glamorous Parks for their livelihood until they get entangled in an unexpected incident.","genres":["Comedy","Thriller","Drama"],"release_date":"2019-05-30","vote_average":8.5,"vote_count":16000,"popularity":75.8}
          '
          
          echo ""
          echo "Verifying..."
          curl -s "$ES_URL/movies/_count"
          echo ""
          echo "Done! Loaded movies into Elasticsearch."
