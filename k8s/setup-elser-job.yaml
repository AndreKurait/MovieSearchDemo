apiVersion: batch/v1
kind: Job
metadata:
  name: setup-elser
  namespace: movie-demo
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: setup
        image: curlimages/curl:latest
        env:
        - name: ES_URL
          value: "http://elasticsearch.movie-demo.svc.cluster.local:9200"
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -e
          echo "=== Index Setup ==="

          # Wait for ES to be ready
          echo "Waiting for Elasticsearch..."
          for i in $(seq 1 60); do
            if curl -sf "$ES_URL/_cluster/health" > /dev/null 2>&1; then
              echo "Elasticsearch is ready"
              break
            fi
            echo "  Waiting... ($i/60)"
            sleep 5
          done

          # Recreate movies index (keyword search only)
          echo ""
          echo "=== Creating movies index ==="
          curl -s -X DELETE "$ES_URL/movies" || echo "No existing index"
          sleep 2

          curl -s -X PUT "$ES_URL/movies" \
            -H 'Content-Type: application/json' \
            -d '{
              "settings": {
                "number_of_shards": 1,
                "number_of_replicas": 0,
                "analysis": {
                  "analyzer": {
                    "autocomplete": {
                      "type": "custom",
                      "tokenizer": "standard",
                      "filter": ["lowercase", "edge_ngram_filter"]
                    },
                    "autocomplete_search": {
                      "type": "custom",
                      "tokenizer": "standard",
                      "filter": ["lowercase"]
                    }
                  },
                  "filter": {
                    "edge_ngram_filter": {
                      "type": "edge_ngram",
                      "min_gram": 2,
                      "max_gram": 15
                    }
                  }
                }
              },
              "mappings": {
                "properties": {
                  "title": {
                    "type": "text",
                    "analyzer": "english",
                    "fields": {
                      "keyword": {"type": "keyword"},
                      "raw": {"type": "text", "analyzer": "standard"},
                      "autocomplete": {
                        "type": "text",
                        "analyzer": "autocomplete",
                        "search_analyzer": "autocomplete_search"
                      }
                    }
                  },
                  "tagline": {"type": "text", "analyzer": "english"},
                  "overview": {"type": "text", "analyzer": "english"},
                  "genres": {"type": "keyword"},
                  "release_date": {"type": "date", "ignore_malformed": true},
                  "vote_average": {"type": "float"},
                  "vote_count": {"type": "integer"},
                  "popularity": {"type": "float"},
                  "poster_path": {"type": "keyword"},
                  "backdrop_path": {"type": "keyword"},
                  "runtime": {"type": "integer"},
                  "original_language": {"type": "keyword"},
                  "cast": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "text",
                        "fields": {
                          "keyword": {"type": "keyword"}
                        }
                      },
                      "character": {"type": "text"},
                      "profile_path": {"type": "keyword"}
                    }
                  },
                  "crew": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "text",
                        "fields": {
                          "keyword": {"type": "keyword"}
                        }
                      },
                      "job": {"type": "keyword"}
                    }
                  },
                  "keywords": {
                    "type": "keyword",
                    "fields": {
                      "text": {"type": "text", "analyzer": "english"}
                    }
                  }
                }
              }
            }' && echo " -> Index created"

          echo ""
          echo "=== Index Setup Complete ==="
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
