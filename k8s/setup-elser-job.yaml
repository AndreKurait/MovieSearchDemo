apiVersion: batch/v1
kind: Job
metadata:
  name: setup-elser
  namespace: movie-demo
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: setup
        image: curlimages/curl:latest
        env:
        - name: ES_URL
          value: "http://elasticsearch.movie-demo.svc.cluster.local:9200"
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -e
          echo "=== ELSER v2 Setup ==="

          # Wait for ES to be ready
          echo "Waiting for Elasticsearch..."
          for i in $(seq 1 60); do
            if curl -sf "$ES_URL/_cluster/health" > /dev/null 2>&1; then
              echo "Elasticsearch is ready"
              break
            fi
            echo "  Waiting... ($i/60)"
            sleep 5
          done

          # Step 0: Start trial license (required for ML features)
          echo ""
          echo "=== Step 0: Starting trial license ==="
          curl -s -X POST "$ES_URL/_license/start_trial?acknowledge=true" || echo "Trial already active"

          # Step 1: Download ELSER v2 model
          echo ""
          echo "=== Step 1: Downloading ELSER v2 model ==="
          curl -s -X PUT "$ES_URL/_ml/trained_models/.elser_model_2" \
            -H 'Content-Type: application/json' \
            -d '{"input": {"field_names": ["text_field"]}}' \
            --max-time 600 || echo "Model may already exist, continuing..."

          # Step 2: Start model deployment
          echo ""
          echo "=== Step 2: Starting ELSER model deployment ==="
          curl -s -X POST "$ES_URL/_ml/trained_models/.elser_model_2/deployment/_start?wait_for=started&timeout=5m" \
            -H 'Content-Type: application/json' \
            -d '{
              "number_of_allocations": 1,
              "threads_per_allocation": 2,
              "queue_capacity": 500
            }' --max-time 360 && echo " -> Model deployed"

          # Step 3: Create the ingest pipeline
          echo ""
          echo "=== Step 3: Creating ELSER ingest pipeline ==="
          curl -s -X PUT "$ES_URL/_ingest/pipeline/elser-ingest" \
            -H 'Content-Type: application/json' \
            -d '{
              "description": "ELSER v2 inference pipeline for movie search",
              "processors": [
                {
                  "inference": {
                    "model_id": ".elser_model_2",
                    "input_output": [
                      {
                        "input_field": "overview",
                        "output_field": "overview_embedding"
                      }
                    ]
                  }
                },
                {
                  "inference": {
                    "model_id": ".elser_model_2",
                    "input_output": [
                      {
                        "input_field": "title",
                        "output_field": "title_embedding"
                      }
                    ]
                  }
                }
              ],
              "on_failure": [
                {
                  "set": {
                    "field": "elser_error",
                    "value": "{{_ingest.on_failure_message}}"
                  }
                }
              ]
            }' && echo " -> Pipeline created"

          # Step 4: Recreate movies index with ELSER fields
          echo ""
          echo "=== Step 4: Recreating movies index ==="
          curl -s -X DELETE "$ES_URL/movies" || echo "No existing index"
          sleep 2

          curl -s -X PUT "$ES_URL/movies" \
            -H 'Content-Type: application/json' \
            -d '{
              "settings": {
                "number_of_shards": 1,
                "number_of_replicas": 0,
                "default_pipeline": "elser-ingest",
                "index.mapping.total_fields.limit": 5000,
                "analysis": {
                  "analyzer": {
                    "autocomplete": {
                      "type": "custom",
                      "tokenizer": "standard",
                      "filter": ["lowercase", "edge_ngram_filter"]
                    },
                    "autocomplete_search": {
                      "type": "custom",
                      "tokenizer": "standard",
                      "filter": ["lowercase"]
                    }
                  },
                  "filter": {
                    "edge_ngram_filter": {
                      "type": "edge_ngram",
                      "min_gram": 2,
                      "max_gram": 15
                    }
                  }
                }
              },
              "mappings": {
                "properties": {
                  "title": {
                    "type": "text",
                    "analyzer": "english",
                    "fields": {
                      "keyword": {"type": "keyword"},
                      "raw": {"type": "text", "analyzer": "standard"},
                      "autocomplete": {
                        "type": "text",
                        "analyzer": "autocomplete",
                        "search_analyzer": "autocomplete_search"
                      }
                    }
                  },
                  "tagline": {"type": "text", "analyzer": "english"},
                  "overview": {"type": "text", "analyzer": "english"},
                  "genres": {"type": "keyword"},
                  "release_date": {"type": "date", "ignore_malformed": true},
                  "vote_average": {"type": "float"},
                  "vote_count": {"type": "integer"},
                  "popularity": {"type": "float"},
                  "poster_path": {"type": "keyword"},
                  "backdrop_path": {"type": "keyword"},
                  "runtime": {"type": "integer"},
                  "original_language": {"type": "keyword"},
                  "cast": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "text",
                        "fields": {
                          "keyword": {"type": "keyword"}
                        }
                      },
                      "character": {"type": "text"},
                      "profile_path": {"type": "keyword"}
                    }
                  },
                  "crew": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "text",
                        "fields": {
                          "keyword": {"type": "keyword"}
                        }
                      },
                      "job": {"type": "keyword"}
                    }
                  },
                  "keywords": {
                    "type": "keyword",
                    "fields": {
                      "text": {"type": "text", "analyzer": "english"}
                    }
                  },
                  "overview_embedding": {"type": "sparse_vector"},
                  "title_embedding": {"type": "sparse_vector"}
                }
              }
            }' && echo " -> Index created"

          echo ""
          echo "=== ELSER Setup Complete ==="
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
